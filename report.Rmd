---
title: "Template for Project 1 Data Analysis Report (replace it with your own title)"
author: "Zeng Fung Liew (913802324), "
date: "February 2, 2021"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo=FALSE, warning=FALSE, message=FALSE)
```


# Introduction


# Background 


# Descriptive analysis 

## Overview
To get a good sense on how the data is distributed, each state in the USA is plotted with different shades of purple to signify the rate of vehicle fatalities per 100k people. The reason that the rate of fatalities was chosen instead of the number itself is due to the difference in population in each state. In the map below, while California has an average of more than 5000 fatalities per year, the number is relatively small compared to its population size. In other words, for every 10k people in the state, only 2 people were involved in fatal vehicle accidents.

On the other hand, Texas seemed to have the highest average rate of fatalities per 10k people. With an average population of 16.3 million people between 1982 and 1988, this meant that for every 10k people in Texas, 3.65 people were involved in fatal accidents, which was close to double the amount of California!

```{r}
## Liela's codes
library(AER)
library(ggplot2)
library(plotly)
library(tidyverse)
library(dplyr)
data("Fatalities")

data <- Fatalities  %>%
  mutate(fatal_r=(fatal/pop)*10000,afatal_p=(afatal/pop)*10000) %>% 
  select(state,year,fatal_r,afatal_p,spirits,unemp,beertax,drinkage,dry,breath,jail,service,pop,fatal,afatal)

# mean (years)
mapping <- data %>%  
  select(state,year,afatal_p,fatal_r,pop,fatal,afatal) %>%
  mutate(state=toupper(state))
map <- mapping %>% 
  group_by(state) %>% 
  summarise(fatal=round(mean(fatal),2),fatal_r_mean=round(mean(fatal_r),2))
map$hover <- with(map, paste(state, "<br>Mean Fatalities/year: ", fatal, "<br>Mean Fatalities per 10k pop./year: ", fatal_r_mean))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
fig <- plot_geo(map, locationmode = 'USA-states')
fig <- fig %>% 
  add_trace(
    z = ~fatal_r_mean, text=~hover,locations = ~state,
    color = ~fatal_r_mean, colors = 'Purples'
  )
fig <- fig %>% 
  colorbar(title = "Vehicle fatalities/10k pop.")
fig <- fig %>% 
  layout(
    title = 'US Traffic Fatalities',
    geo = g,
  yaxis = list(type = "log")
  )
fig
rm(list=ls())
```

## Exploratory Data Analysis
As the focus of this data analysis is to find out whether laws that were implemented to tackle drunk driving related fatalities, only a subset of the variables from the `Fatalities` dataset were used. In particular, response variables that were alcohol-related such as the total number of fatalities and alcohol fatalies were examined, while predictor variables that are closely related to alcohol-consumption-driven laws were also analyzed.

### Univariate Analysis
We start off the exploratory data analysis procedure by individually examining the predictor and response variables. The goal here is to understand how the data is distributed, which helps set an expectation on how the variables correlate with each other, or whether model assumptions will be met.

#### Predictor Variables
As we are looking into how alcohol-consumption-driven laws impact the rate of alcohol-related fatalities, some variables of interest include spirit consumptions, beer tax, proportion of the population living in dry counties, minimum drinking age, and the mandatory punishments implemented by each state throughout the 7 years.

The plot below shows the top 5 states in terms of average spirits consumptions, average beer tax, and average proportion of population living in dry counties between 1982 and 1988. Other than North Carolina (NC) being in the top 5 states for beer tax and containing large proportion of dry residents, it can be seen that there is no other "standout" state below, ie. there's no state present in more than one of the top 5 categories.
```{r}
## Yixing's codes
library(tidyverse)
library(AER)
library(ggplot2)
library(grid)

data('Fatalities')
Fatalities$state = toupper(Fatalities$state)
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)

factor1 = names(drunkdrive) %in% c("year","breath","jail","service")
factor2 = names(drunkdrive) %in% c("state","breath","jail","service")
state_mean = aggregate(.~state,data=drunkdrive[,!factor1], FUN = "mean")
year_mean = aggregate(.~year,data=drunkdrive[,!factor2], FUN = "mean")

#state mean spirits consumption ordered bar chart
state_mean_subset = state_mean[order(state_mean$spirits, decreasing = TRUE)[1:5],1:2]
p1 = ggplot(state_mean_subset,aes(x=reorder(state,-spirits),y=spirits)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "Avg. Spirits Consumption")
#state mean beertax ordered bar chart
state_mean_subset = state_mean[order(state_mean$beertax, decreasing = TRUE)[1:5],c(1,3)]
p2 = ggplot(state_mean_subset,aes(x=reorder(state,-beertax),y=beertax)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "Avg. Beer Tax")
# state_mean dry ordered bar chart
state_mean_subset = state_mean[order(state_mean$dry, decreasing = TRUE)[1:5],c(1,5)]
p3 = ggplot(state_mean_subset,aes(x=reorder(state,-dry),y=dry)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "% Dry County Residents")

gridExtra::grid.arrange(p1,p2,p3, nrow = 1,
                        top = textGrob("Top 5 States in Spirits Consumption, Beer Tax, and % Dry Residents",gp=gpar(fontsize=15,font=3)))
rm(list=ls())
```

On the other hand, it can be seen that there has been an increasing implementation/tightening of laws throughout the 7 years. The most obvious changes here is the number of states that increased the minimum drinking age. In 1982, almost half the country had set their minimum drinking age to be less than 21, and yet most of the states have opted for 21 to be the minimum drinkage 7 years later.

Additionally, there seem to be a slight increasing trend in the number of states that implement testings (breath test) and punishments (mandatory jail sentence and mandatory community services) between 1982 and 1988. We need to note, however, that the number of states implementing mandatory jail sentences decreased very slightly from 1986 to 1988. This raises the question of whether a mandatory jail sentence is effective in combating the issue of drunk driving. Such questions will be addressed after fitting a suitable model.
```{r}
## Yixing's codes
library(AER)
library(ggplot2)
data("Fatalities")
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)

# bar plot
# drinkage: categorized to four levels: [18,19),[19,20),[20,21),[21,22])
drinkagec <- cut(drunkdrive$drinkage,
  breaks = 18:22, include.lowest = TRUE, right = FALSE)
drunkdrive <- drunkdrive %>% mutate(drinkagec = drinkagec)
# stacked barchart of drinkage for each year (many states changed their min. drinking age over yers)
drinkage_year = drunkdrive %>% group_by(year,drinkagec) %>%
  summarise(state_number = n())
p2 = ggplot(drinkage_year,aes(x=year,y=state_number,fill=drinkagec))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Min. drink age") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=8), axis.text.x = element_text(angle=45))

# stacked barchart of breath for each year (many states changed their min. drinking age over yers)
breath_year = drunkdrive %>% group_by(year,breath) %>%summarise(state_number = n())
p3 = ggplot(breath_year,aes(x=year,y=state_number,fill=breath))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Prelim. breath test") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=7), axis.text.x = element_text(angle=45))

# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
jail_year = drunkdrive %>% group_by(year,jail) %>%summarise(state_number = n())
p4 = ggplot(jail_year,aes(x=year,y=state_number,fill=jail))+
  geom_bar(position="Fill",stat="identity") +
  labs(y="Percent of states", fill = "Mand. Jail") + 
  scale_fill_brewer(palette="Blues") + 
  theme(axis.text.x = element_text(angle=45))

# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
service_year = drunkdrive %>% group_by(year,service) %>%summarise(state_number = n())
p5 = ggplot(service_year,aes(x=year,y=state_number,fill=service))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Mand. comm. service") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=7), axis.text.x = element_text(angle=45))

# draw all plots
gridExtra::grid.arrange(p2,p3,p4,p5, nrow = 2)

rm(list=ls())
```

#### Response Variables
After observing the trend of the implemented laws, the focus is now switched to analyzing the distribution of fatalities and alcohol fatalities across the country. A quick look at the top two histograms below might suggest that a large portion of states have less than 1000 fatalities per year, and less than 500 alcohol related fatalities per year. However, each state's population need to be taken into account in this case due to the significant variation in population sizes across the country. Our new histograms (bottom two) tells us that the distributions of the data can be approximated as normal. Since the goal of this analysis is to discuss the effects of alcohal-related law implementations, the alcohol-related fatalities to overall fatalities ratio becomes our main topic of interest.
```{r}
## Zengfung's codes
library(AER)
data("Fatalities")
attach(Fatalities)

par(mfrow=c(2,2))
hist(fatal, main = "Number of Fatalities", xlab = "fatalities")
hist(afatal, main = "Number of Alc. Related Fatalities", xlab = "alcohol fatalities")
hist(fatal/pop*10000, main = "Fatalities/10k pop.", xlab = "fatalities/10k pop.")
hist(afatal/fatal, main="% Alc. Fatalities", xlab = "% fatalities related to alcohol")

rm(list=ls())
```

The plot below shows the proportion of alcohol-related fatalities of each state throughout the years. It can be seen that the proportion of alcohol-related fatalities have been either constant or decreasing in those 7 years. This is more prevalent in states such as Kansas (KS), North Dakota (ND), and Arkansas(AR). 
However, there is one exception to this trend. In the line plot below, we observe that Mississipi had a significant increase in the proportion of alcohol fatalities from 1983 to 1988.
```{r}
## Liela's codes
library(AER)
library(plotly)
library(dplyr)
data("Fatalities")
Fatalities$pafatal = Fatalities$afatal/Fatalities$fatal
Fatalities$state = toupper(Fatalities$state)

Fatalities %>%
  group_by(state) %>%
  plot_ly(x = ~year, y = ~pafatal, color = ~state) %>%
  add_lines(text = ~state) %>%
  layout(title = "% Alc. Fatalities by State",
         xaxis = list(title = "Year"),
         yaxis = list(title = "% Alc. Fatalities"))

rm(list=ls())
```

### Multivariate Analysis

```{r}
## Apurv's codes
library(AER)
library(ggplot2)
library(GGally)
library(plotly)
library(dplyr)
library(panelr)
library(tidyverse)

# load data
data("Fatalities")
attach(Fatalities)
rfatal = fatal/pop*100000
Fatalities$rfatal = rfatal
rafatal = afatal/pop*100000
Fatalities$rafatal = rafatal
pafatal = afatal/fatal
Fatalities$pafatal = pafatal
dataset<- data.frame(rfatal,rafatal,year,state,unemp,beertax,drinkage,jail,service,breath,dry,pop,pafatal)
dataset<-na.omit(dataset)
fatal.data<-panel_data(dataset, id=state, wave=year)


# pairs plot
ggpairs(dataset, columns = c(1,2,5:7,11,12), aes(color = year, alpha = 0.5)) +
  ggtitle("Pairs plot") 
```

```{r}
## Apurv's codes
par(mfrow = c(2,4))
boxplot(rfatal~jail, main ='Fatality vs Jail',
xlab='Jail',ylab='Fatality Rate',col=rainbow(4))

boxplot(rfatal~service, main ='Fatality vs Service',
xlab='Service',ylab='Fatality Rate',col=rainbow(4))

boxplot(rfatal~breath, main ='Fatality vs Breath Test',
xlab='Breath',ylab='Fatality Rate',col=rainbow(4))

boxplot(pafatal~year, main = 'Alc.Fatality % vs Year',
        xlab = 'Year', ylab = 'Alc. Fatality Rate', col=rainbow(7),
        cex.main=0.8)

boxplot(pafatal~jail, main ='Alc.Fatality % vs Jail',
xlab='Jail',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=0.8)

boxplot(pafatal~service, main ='Alc.Fatality % vs Service',
xlab='Service',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=0.8)

boxplot(pafatal~breath, main ='Alc.Fatality % vs Breath Test',
xlab='Breath',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=0.8)

drinkage = as.factor(floor(drinkage))
Fatalities$drinkage = drinkage
boxplot(pafatal~drinkage, main = 'Alc.Fatality % vs Drinkage',
        xlab = "Drink Age", ylab = "Alc. Fatality Rate", col=rainbow(4),
        cex.main=0.8)
rm(list=ls())
```

```{r}
## Zengfung's codes
library(ggplot2)
library(plotly)
library(AER)
data("Fatalities")
Fatalities = na.omit(Fatalities)
Fatalities$afatal_prop = Fatalities$afatal/Fatalities$fatal
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))

p1 = ggplot(data = Fatalities, aes(x = dry, y = afatal_prop, color = jail, frame = year)) + 
  geom_point(alpha = 0.7) + 
  ylab("% alcohol fatalities") +
  ggtitle("Dry, Unemployment %, and Beer Tax") +
  theme(legend.title = element_blank(), legend.position = "none")
p2 = ggplot(data = Fatalities, aes(x = unemp, y = afatal_prop, color = jail, frame = year)) + 
  geom_point(alpha = 0.7) + 
  theme(legend.title = element_blank(), legend.position = "none")
p3 = ggplot(data = Fatalities, aes(x = beertax, y = afatal_prop, color = jail, frame = year)) +
  geom_point(alpha = 0.7) +
  labs(color = "Jail")
p4 = ggplot(data = Fatalities, aes(x = spirits, y = afatal_prop, color = jail, frame = year)) +
  geom_point(alpha = 0.7) +
  theme(legend.title = element_blank(), legend.position = "bottom")

fig = subplot(ggplotly(p1), ggplotly(p3), ggplotly(p2), ggplotly(p4), nrows = 2, shareY = TRUE)
fig 

rm(list=ls())
```

```{r}
## Zengfung's codes
library(AER)
library(ggplot2)
data("Fatalities")
Fatalities = na.omit(Fatalities)
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))

ggplot(data = Fatalities, aes(x = youngdrivers, fill = drinkage_cat)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  facet_grid(rows = vars(year)) +
  labs(x = "% Young Drivers", fill = "Min. Drink Age") +
  ggtitle("Distribution of Young Drivers based on Min. Drink Age")
rm(list=ls())
```


# Inferential analysis 
```{r}
library(AER)
library(AER)
library(ggplot2)
library(gplots)
library(plotly)
library(tidyverse)
library(dplyr)
rm(list=ls())
data("Fatalities")
Fatalities$drinkage <-as.factor(floor(Fatalities$drinkage))
# apply(is.na(Fatalities), 2, which) 
data <- Fatalities  %>%mutate(fatal_r=(fatal/pop)*10000,afatal_r=(afatal/pop)*10000) %>% select(state,year,fatal_r,afatal_r,spirits,unemp,beertax,drinkage,dry,breath,jail,service,pop,fatal,nfatal)

library(plm)
plm_1 <- plm(fatal_r~unemp+jail+drinkage+beertax+spirits+dry+service+breath,data=data,index=c("state","year"),model="within")
coeftest(plm_1)
summary(plm_1)

plm_a <- plm(afatal_r~unemp+jail+drinkage+beertax+spirits+dry+service+breath,data=data,index=c("state","year"),model="within")
coeftest(plm_a)
summary(plm_a)
```


# Sensitivity analysis 


# Causal interpretation 


# Discussion 


# Acknowledgement {-}


# Reference {-}


# Session info {-}


```{r}
sessionInfo()
```
