---
title: "STA207_project2_YL"
author: "YL"
date: "2/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(AER)
library(ggplot2)
```

```{r}
data('Fatalities')
names(Fatalities)
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
```

```{r}
## data inspect
sapply(drunkdrive,class)
# identify missing values
summary(drunkdrive)
drunkdrive[!complete.cases(drunkdrive),] # california 1988 jail service
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)
```

```{r,warning=FALSE}
# EDA: univariate visualization
factor1 = names(drunkdrive) %in% c("year","breath","jail","service")
factor2 = names(drunkdrive) %in% c("state","breath","jail","service")
state_mean = aggregate(.~state,data=drunkdrive[,!factor1], FUN = "mean")
year_mean = aggregate(.~year,data=drunkdrive[,!factor2], FUN = "mean")


#state mean spirits consumption ordered bar chart
ggplot(state_mean,aes(x=reorder(state,-spirits),y=spirits)) + geom_bar(stat = "identity",fill = "steelblue")+theme(axis.text.x = element_text(angle=45))
#state mean beertax ordered bar chart
ggplot(state_mean,aes(x=reorder(state,-beertax),y=beertax)) + geom_bar(stat = "identity",fill = "steelblue")+theme(axis.text.x = element_text(angle=45))
# drinkage: categorized to four levels: [18,19),[19,20),[20,21),[21,22])
drinkagec <- cut(drunkdrive$drinkage,
  breaks = 18:22, include.lowest = TRUE, right = FALSE)
drunkdrive <- drunkdrive %>% mutate(drinkagec = drinkagec)
# stacked barchart of drinkage for each year (many states changed their min. drinking age over yers)
drinkage_year = drunkdrive %>% group_by(year,drinkagec) %>%summarise(state_number = n())
ggplot(drinkage_year,aes(x=year,y=state_number,fill=drinkagec))+geom_bar(position="Fill",stat="identity") + labs(y="Percent of states", legend = "Minium drinking age") + scale_fill_brewer(palette="Blues")
# state_mean dry ordered bar chart
ggplot(state_mean,aes(x=reorder(state,-dry),y=dry)) + geom_bar(stat = "identity",fill = "steelblue")+theme(axis.text.x = element_text(angle=45))
# stacked barchart of breath for each year (many states changed their min. drinking age over yers)
breath_year = drunkdrive %>% group_by(year,breath) %>%summarise(state_number = n())
ggplot(breath_year,aes(x=year,y=state_number,fill=breath))+geom_bar(position="Fill",stat="identity") + labs(y="Percent of states", legend = "Prelim breath test law?") + scale_fill_brewer(palette="Blues")
# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
jail_year = drunkdrive %>% group_by(year,jail) %>%summarise(state_number = n())
ggplot(jail_year,aes(x=year,y=state_number,fill=jail))+geom_bar(position="Fill",stat="identity") + labs(y="Percent of states", legend = "Mandatory jail sentence?") + scale_fill_brewer(palette="Blues")
# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
service_year = drunkdrive %>% group_by(year,service) %>%summarise(state_number = n())
ggplot(service_year,aes(x=year,y=state_number,fill=service))+geom_bar(position="Fill",stat="identity") + labs(y="Percent of states", legend = "Mandatory community service?") + scale_fill_brewer(palette="Blues")
# state_mean fatal_rate histogram
ggplot(drunkdrive,aes(x=fatal_rate))+geom_histogram(binwidth = 0.2, color='steelblue',fill='steelblue1')
# state_mean afatal_rate histogram
ggplot(drunkdrive,aes(x=afatal_rate))+geom_histogram(binwidth = 0.1, color='steelblue',fill='steelblue1')
```

