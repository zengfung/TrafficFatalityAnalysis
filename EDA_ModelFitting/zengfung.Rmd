---
title: "zengfung's notes"
author: "Zeng Fung Liew"
date: "2/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
```

# Import data
```{r}
library(AER)
data("Fatalities")
Fatalities$fatal_rate = Fatalities$fatal/Fatalities$pop*10000
Fatalities$afatal_rate = Fatalities$afatal/Fatalities$pop*10000
Fatalities$nfatal_rate = Fatalities$nfatal/Fatalities$pop*10000
Fatalities$afatal_prop = Fatalities$afatal/Fatalities$fatal
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))

attach(Fatalities)

```

# Univariate EDA
## Predictor variables
```{r}
# the data for all 48 states were present for each year
table(year)
```

```{r}
par(mfrow=c(2,3))
# beertax
hist(beertax)
# percent residing in dry counties
hist(dry)
hist(unemp)
pie(table(breath), main = "breath")
pie(table(jail), main = "jail")
pie(table(service), main = "service")
```

Question: do we want to round down the drink age? Then make this categorical?
```{r}
table(drinkage)
# round down age
pie(table(floor(drinkage)), main="drinkage")
```

## Response variables
```{r}
par(mfrow=c(2,3))
hist(fatal, main = "number of fatalities")
hist(nfatal, main = "number of night fatalities")
hist(afatal, main = "number of alcohol related fatalities")
hist(fatal/pop, main = "rate of fatalities")
hist(nfatal/pop, main="rate of night fatalities")
hist(afatal/pop, main = "rate of afatal")

hist(nfatal/fatal, main="prop. of nfatal among fatal")
hist(afatal/fatal, main="prop. of afatal among fatal")
hist(afatal/nfatal, main="prop. of afatal among nfatal") # doesn't work
```

# Multivariate EDA
mean response plot:

```{r}
library(gplots)
par(mfrow=c(2,2))
plotmeans(afatal_prop ~ drinkage_cat)
plotmeans(afatal_prop ~ breath)
plotmeans(afatal_prop ~ jail)
plotmeans(afatal_prop ~ service)
par(mfrow=c(2,1))
plotmeans(afatal_prop ~ year)
plotmeans(afatal_prop ~ state)
```

`jail` and `service` have shown slight increase by year. <br>
`drinkage` have mainly shifted from 18-19 in 1982 to 21 in 1988.
```{r}
table(jail, year)
table(service, year)
table(drinkage_cat, year)
```


```{r}
library(ggplot2)
library(plotly)
p1 = ggplot(data = Fatalities, aes(x = dry, y = afatal_prop, color = drinkage_cat, frame = year)) + 
  geom_point(alpha = 0.7) + 
  ylab("% alcohol fatalities") +
  ggtitle("Dry, Unemployment %, and Beer Tax") +
  theme(legend.title = element_blank(), legend.position = "none")
p2 = ggplot(data = Fatalities, aes(x = unemp, y = afatal_prop, color = drinkage_cat, frame = year)) + 
  geom_point(alpha = 0.7) + 
  theme(legend.title = element_blank(), legend.position = "none")
p3 = ggplot(data = Fatalities, aes(x = beertax, y = afatal_prop, color = drinkage_cat, frame = year)) +
  geom_point(alpha = 0.7) +
  labs(color = "Drink Age")

fig = subplot(ggplotly(p1), ggplotly(p2), ggplotly(p3), nrows = 1, shareY = TRUE)
fig 

p4 = ggplot(data = Fatalities, aes(x = youngdrivers, fill = drinkage_cat)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  facet_grid(rows = vars(year))
p4
```

dont think unemployment rate is a good predictor, as it doesnt fit our goals from this analysis. can add into the discussion sections tho

percentage of young drivers have decreased over the years as the number of states that changed their drinkage to 21 has increased. however, later on (if i use a mixed effects model) drinkage is not exactly a good predictor (not significant).

```{r visualization}
library(AER)
library(AER)
library(ggplot2)
library(plotly)
library(tidyverse)
library(dplyr)
rm(list=ls())
data("Fatalities")

# mean (years)
mapping <- Fatalities %>% select(state,year,pop,fatal) %>% mutate(state=toupper(state))
map <- mapping %>% group_by(state) %>% summarise(pop=mean(pop),fatal=mean(fatal)) 
map$hover <- with(map, paste(state, '<br>', "pop", pop, "fatal", fatal))

# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig <- plot_geo(map, locationmode = 'USA-states')
fig <- fig %>% add_trace(
    z = ~fatal, text=~hover,locations = ~state,
    color = ~fatal, colors = 'Purples'
  )
fig <- fig %>% colorbar(title = "Number of vehicle fatalities")
fig <- fig %>% layout(
    title = 'US Traffic Fatalities',
    geo = g,
  yaxis = list(type = "log")
  )
fig

# by year
gg <- ggplot(mapping, aes(pop,fatal, color = state)) +
  geom_point(aes(size = fatal, frame = year, ids = state)) +
  scale_x_log10()
ggplotly(gg)
```


# Model fitting
Note: goal is to observe whether the type of law implemented to tacker drunk driving can actually prevent fatalities

* panel linear model, using state as panel <br>
not entirely sure how to interpret the `model="within"` part. <br>
if i index on "state", beertax is not a significant predictor. <br> 
if i index on "year", drinkage is not a significant predictor
```{r}
library(plm)
model = plm(afatal_prop ~ spirits + beertax + jail + service + drinkage,
            data = Fatalities,
            index = "state",
            model = "within")
summary(model)
```
* lmer model with state as random effect
```{r}
library(lme4)
lmer.model = lmer(afatal_prop ~ beertax + jail + service + drinkage_cat + (1|state))
summary(lmer.model)
anova(lmer.model)
```
if i use year as random effect, it seems that drink age does not really correlate to alcohol fatalities. <br>
if i use state as random effect, jail is not a significant predictor of alcohol fatalities

* regular lm model <br>
state and year are highly significant predictors, but they are not what we're after <br>
if we dont include them this causes drinkage and jail to not be significant predictors

```{r}
lm.model = lm(afatal_prop ~ beertax + jail + service + drinkage_cat )
summary(lm.model)
anova(lm.model)
```

# Trying out with transformation of variables
seems like it's slightly better, but its way harder to interpret the findings now
```{r}
library(MASS)
boxcox(lm.model)
Fatalities$inv_afatal_prop = 1/Fatalities$afatal_prop
```

* panel linear model <br>
```{r}
library(plm)
plm.model = plm(inv_afatal_prop ~ beertax + jail + service + drinkage,
            data = Fatalities,
            index = "state",
            model = "within")
summary(plm.model)
```

* random effects model <br>
jail is still the least significant
```{r}
lmer.model = lmer(inv_afatal_prop ~ beertax + jail + service + drinkage_cat + (1|state),data = Fatalities)
summary(lmer.model)
anova(lmer.model)
```

* fixed effects model <br>
```{r}
lm.model = lm(inv_afatal_prop ~ beertax + jail + service + drinkage_cat, data = Fatalities )
summary(lm.model)
anova(lm.model)
```
