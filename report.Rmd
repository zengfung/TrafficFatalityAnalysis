---
title: "Template for Project 1 Data Analysis Report (replace it with your own title)"
author: "Zeng Fung Liew (913802324), "
date: "February 2, 2021"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo=FALSE, warning=FALSE, message=FALSE)
```


# Introduction


# Background 


# Descriptive analysis 

## Overview
```{r}
## Liela's codes
library(AER)
library(ggplot2)
library(plotly)
library(tidyverse)
library(dplyr)
data("Fatalities")

data <- Fatalities  %>%
  mutate(fatal_r=(fatal/pop)*10000,afatal_p=(afatal/pop)*10000) %>% 
  select(state,year,fatal_r,afatal_p,spirits,unemp,beertax,drinkage,dry,breath,jail,service,pop,fatal,afatal)

# mean (years)
mapping <- data %>%  
  select(state,year,afatal_p,fatal_r,pop,fatal,afatal) %>%
  mutate(state=toupper(state))
map <- mapping %>% 
  group_by(state) %>% 
  summarise(fatal=round(mean(fatal),2),fatal_r_mean=round(mean(fatal_r),2))
map$hover <- with(map, paste(state, "<br>Mean Fatalities/year: ", fatal, "<br>Mean Fatalities per 10k pop./year: ", fatal_r_mean))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
fig <- plot_geo(map, locationmode = 'USA-states')
fig <- fig %>% 
  add_trace(
    z = ~fatal_r_mean, text=~hover,locations = ~state,
    color = ~fatal_r_mean, colors = 'Purples'
  )
fig <- fig %>% 
  colorbar(title = "Vehicle fatalities/10k pop.")
fig <- fig %>% 
  layout(
    title = 'US Traffic Fatalities',
    geo = g,
  yaxis = list(type = "log")
  )
fig
rm(list=ls())
```

## Exploratory Analysis
### Univariate Analysis

#### Predictor Variables

```{r}
## Yixing's codes
library(tidyverse)
library(AER)
library(ggplot2)
library(grid)

data('Fatalities')
Fatalities$state = toupper(Fatalities$state)
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)

factor1 = names(drunkdrive) %in% c("year","breath","jail","service")
factor2 = names(drunkdrive) %in% c("state","breath","jail","service")
state_mean = aggregate(.~state,data=drunkdrive[,!factor1], FUN = "mean")
year_mean = aggregate(.~year,data=drunkdrive[,!factor2], FUN = "mean")

#state mean spirits consumption ordered bar chart
state_mean_subset = state_mean[order(state_mean$spirits, decreasing = TRUE)[1:5],1:2]
p1 = ggplot(state_mean_subset,aes(x=reorder(state,-spirits),y=spirits)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "Avg. Spirits Consumption")
#state mean beertax ordered bar chart
state_mean_subset = state_mean[order(state_mean$beertax, decreasing = TRUE)[1:5],c(1,3)]
p2 = ggplot(state_mean_subset,aes(x=reorder(state,-beertax),y=beertax)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "Avg. Beer Tax")
# state_mean dry ordered bar chart
state_mean_subset = state_mean[order(state_mean$dry, decreasing = TRUE)[1:5],c(1,5)]
p3 = ggplot(state_mean_subset,aes(x=reorder(state,-dry),y=dry)) + 
  geom_bar(stat = "identity",fill = "steelblue")+
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "State", y = "% Dry County Residents")

gridExtra::grid.arrange(p1,p2,p3, nrow = 1,
                        top = textGrob("Top 5 States in Spirits Consumption, Beer Tax, and % Dry Residents",gp=gpar(fontsize=15,font=3)))
rm(list=ls())
```

```{r}
## Yixing's codes
library(AER)
library(ggplot2)
data("Fatalities")
drunkdrive = Fatalities[c("state","year","spirits","beertax","drinkage","dry","breath","jail","service","fatal","nfatal","afatal","pop")]
drunkdrive = na.omit(drunkdrive)
# calculate fatal_rate and afatal_rate as #fatal/10000 people
drunkdrive <- drunkdrive %>% mutate(fatal_rate = 10000*fatal/pop,afatal_rate = 10000*afatal/pop)

# bar plot
# drinkage: categorized to four levels: [18,19),[19,20),[20,21),[21,22])
drinkagec <- cut(drunkdrive$drinkage,
  breaks = 18:22, include.lowest = TRUE, right = FALSE)
drunkdrive <- drunkdrive %>% mutate(drinkagec = drinkagec)
# stacked barchart of drinkage for each year (many states changed their min. drinking age over yers)
drinkage_year = drunkdrive %>% group_by(year,drinkagec) %>%
  summarise(state_number = n())
p2 = ggplot(drinkage_year,aes(x=year,y=state_number,fill=drinkagec))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Min. drink age") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=8))

# stacked barchart of breath for each year (many states changed their min. drinking age over yers)
breath_year = drunkdrive %>% group_by(year,breath) %>%summarise(state_number = n())
p3 = ggplot(breath_year,aes(x=year,y=state_number,fill=breath))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Prelim. breath test") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=7))

# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
jail_year = drunkdrive %>% group_by(year,jail) %>%summarise(state_number = n())
p4 = ggplot(jail_year,aes(x=year,y=state_number,fill=jail))+
  geom_bar(position="Fill",stat="identity") +
  labs(y="Percent of states", fill = "Mand. Jail") + 
  scale_fill_brewer(palette="Blues")

# stacked barchart of jail for each year (many states changed their min. drinking age over yers)
service_year = drunkdrive %>% group_by(year,service) %>%summarise(state_number = n())
p5 = ggplot(service_year,aes(x=year,y=state_number,fill=service))+
  geom_bar(position="Fill",stat="identity") + 
  labs(y="Percent of states", fill = "Mand. comm. service") + 
  scale_fill_brewer(palette="Blues") +
  theme(legend.title = element_text(size=7))

# draw all plots
gridExtra::grid.arrange(p2,p3,p4,p5, nrow = 2)

rm(list=ls())
```

#### Response Variables
```{r}
## Zengfung's codes
library(AER)
data("Fatalities")
attach(Fatalities)

par(mfrow=c(2,2))
hist(fatal, main = "Number of Fatalities")
hist(afatal, main = "Number of Alc. Related Fatalities")
hist(fatal/pop*10000, main = "Fatalities/10k pop.")
hist(afatal/fatal, main="% Alc. Fatalities")

rm(list=ls())
```

```{r}
## Liela's codes
library(AER)
library(plotly)
library(dplyr)
data("Fatalities")
Fatalities$pafatal = Fatalities$afatal/Fatalities$fatal
Fatalities$state = toupper(Fatalities$state)

Fatalities %>%
  group_by(state) %>%
  plot_ly(x = ~year, y = ~pafatal, color = ~state) %>%
  add_lines(text = ~state) %>%
  layout(title = "% Alc. Fatalities by State",
         xaxis = list(title = "Year"),
         yaxis = list(title = "% Alc. Fatalities"))

rm(list=ls())
```

### Multivariate Analysis

```{r}
## Apurv's codes
library(AER)
library(ggplot2)
library(GGally)
library(plotly)
library(dplyr)
library(panelr)
library(tidyverse)

# load data
data("Fatalities")
attach(Fatalities)
rfatal = fatal/pop*100000
Fatalities$rfatal = rfatal
rafatal = afatal/pop*100000
Fatalities$rafatal = rafatal
pafatal = afatal/fatal
Fatalities$pafatal = pafatal
dataset<- data.frame(rfatal,rafatal,year,state,unemp,beertax,drinkage,jail,service,breath,dry,pop,pafatal)
dataset<-na.omit(dataset)
fatal.data<-panel_data(dataset, id=state, wave=year)


# pairs plot
ggpairs(dataset, columns = c(1,2,5:7,11,12), aes(color = year, alpha = 0.5)) +
  ggtitle("Pairs plot") 
```

```{r}
## Apurv's codes
par(mfrow = c(2,4))
boxplot(rfatal~jail, main ='Fatality vs Jail',
xlab='Jail',ylab='Fatality Rate',col=rainbow(4))

boxplot(rfatal~service, main ='Fatality vs Service',
xlab='Service',ylab='Fatality Rate',col=rainbow(4))

boxplot(rfatal~breath, main ='Fatality vs Breath Test',
xlab='Breath',ylab='Fatality Rate',col=rainbow(4))

boxplot(pafatal~year, main = 'Alc.Fatality % vs Year',
        xlab = 'Year', ylab = 'Alc. Fatality Rate', col=rainbow(7),
        cex.main=0.8)

boxplot(pafatal~jail, main ='Alc.Fatality % vs Jail',
xlab='Jail',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=0.8)

boxplot(pafatal~service, main ='Alc.Fatality % vs Service',
xlab='Service',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=0.8)

boxplot(pafatal~breath, main ='Alc.Fatality % vs Breath Test',
xlab='Breath',ylab='Alc. Fatality Rate',col=rainbow(4),
        cex.main=0.8)

drinkage = as.factor(floor(drinkage))
Fatalities$drinkage = drinkage
boxplot(pafatal~drinkage, main = 'Alc.Fatality % vs Drinkage',
        xlab = "Drink Age", ylab = "Alc. Fatality Rate", col=rainbow(4),
        cex.main=0.8)
rm(list=ls())
```

```{r}
## Zengfung's codes
library(ggplot2)
library(plotly)
library(AER)
data("Fatalities")
Fatalities = na.omit(Fatalities)
Fatalities$afatal_prop = Fatalities$afatal/Fatalities$fatal
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))

p1 = ggplot(data = Fatalities, aes(x = dry, y = afatal_prop, color = jail, frame = year)) + 
  geom_point(alpha = 0.7) + 
  ylab("% alcohol fatalities") +
  ggtitle("Dry, Unemployment %, and Beer Tax") +
  theme(legend.title = element_blank(), legend.position = "none")
p2 = ggplot(data = Fatalities, aes(x = unemp, y = afatal_prop, color = jail, frame = year)) + 
  geom_point(alpha = 0.7) + 
  theme(legend.title = element_blank(), legend.position = "none")
p3 = ggplot(data = Fatalities, aes(x = beertax, y = afatal_prop, color = jail, frame = year)) +
  geom_point(alpha = 0.7) +
  labs(color = "Jail")
p4 = ggplot(data = Fatalities, aes(x = spirits, y = afatal_prop, color = jail, frame = year)) +
  geom_point(alpha = 0.7) +
  theme(legend.title = element_blank(), legend.position = "bottom")

fig = subplot(ggplotly(p1), ggplotly(p3), ggplotly(p2), ggplotly(p4), nrows = 2, shareY = TRUE)
fig 

rm(list=ls())
```

```{r}
## Zengfung's codes
library(AER)
library(ggplot2)
data("Fatalities")
Fatalities = na.omit(Fatalities)
Fatalities$drinkage_cat = as.factor(floor(Fatalities$drinkage))

ggplot(data = Fatalities, aes(x = youngdrivers, fill = drinkage_cat)) +
  geom_histogram(position = "identity", alpha = 0.5) +
  facet_grid(rows = vars(year)) +
  labs(x = "% Young Drivers", fill = "Min. Drink Age") +
  ggtitle("Distribution of Young Drivers based on Min. Drink Age")
rm(list=ls())
```


# Inferential analysis 
```{r}
library(AER)
library(AER)
library(ggplot2)
library(gplots)
library(plotly)
library(tidyverse)
library(dplyr)
rm(list=ls())
data("Fatalities")
Fatalities$drinkage <-as.factor(floor(Fatalities$drinkage))
# apply(is.na(Fatalities), 2, which) 
data <- Fatalities  %>%mutate(fatal_r=(fatal/pop)*10000,afatal_r=(afatal/pop)*10000) %>% select(state,year,fatal_r,afatal_r,spirits,unemp,beertax,drinkage,dry,breath,jail,service,pop,fatal,nfatal)

library(plm)
plm_1 <- plm(fatal_r~unemp+jail+drinkage+beertax+spirits+dry+service+breath,data=data,index=c("state","year"),model="within")
coeftest(plm_1)
summary(plm_1)

plm_a <- plm(afatal_r~unemp+jail+drinkage+beertax+spirits+dry+service+breath,data=data,index=c("state","year"),model="within")
coeftest(plm_a)
summary(plm_a)
```


# Sensitivity analysis 


# Causal interpretation 
In panel data, measures were conducted on the same entity (state) repeatedly at different time points (years). Also, the fixedd effect model adopted in the current project accounted for unobserved, entity-specific, time-invariant confounders. Given these features, it might seem reasonble to make causal inference for significant predictors on the response variable. However, a fixed effect model requires strong exogeneity assumptions in order to make causal inference, including: (a) no unobserved time-varying confounders; (b) past outcomes do not directly affect current outcome; (c) past treatments do not directly affet current outcome; (d) past outcome do not directly affect current treatment (reverse causation). 

Assumption (a) is hard to verify and also difficult to relax under the fixed effect model. Thus we assumed no time-varying covariates were omitted from the current model and see whether the other assumptions were violated in the current model and how they can be relaxed. Assumption (b) can be relaxed without interfering with the causal inference between current treatment and current outcome so long as we condition on past treatment, and assuming past outcome does no directly affect current treatment. To relax assumption (c), we could add a small number of lagged treatment effect into the model (e.g. treatment from the year before). Last, for assumption (d): no reverse causation, a popular approach to relax it is to include instrumental variables for endogenous predictors. Endogenous predictors are those included in the model but are correlated with the error term. This could happen when the response variable can reversely cause the predictor, or some omitted confounders can affect both dependent and independent variables. Instrumental variables were those not included in the model, associated with the endogenous predictor, but not associated with the unobserved confounders. 

Some previous studies on the traffic policy environment and fatality rate suggested using alcohol regulations as instrumental variables for alcohol consumption when investigating the effect of alcohol consumption on traffic accidents fatality. Such alcohol regulations can only affect traffic accident fatality through alcohol consumption, and there were previous studies showing significant effect of such regulations on alcohol consumption. In the current dataset, the covariate related to alcohol consumption is "spirits", and alcohol regulations include "drinkage" (minimum drinking age), and "beertax". To verify the approporiateness of drinkage and beertax as instrumental variables for spirits consumption, under-identification, weak instrument, and over-identification need to be tested. To test for under-identification is to test the null hypothesis that spirits and beertax or drink age are irrelevant. This could be done through simple t-test and likelihood ratio test. The result showed that beertax was not associated with spirits consumption (Pr(>F) = 0.1012), but drinkage had significant effect (Pr(>F) <0.0001). Thus, beertax failed the under-idetification test. Weak instrument was tested by calculating Cragg-Donald F statistic and comparing it against Stock and Yogo critical values. The null hypothesis (the instrumental variables are weak) can be rejected if the Crgg-Donald F statistic is greater than the criticla value. The Cragg-Donald F statistic calculated for drinkage was 10.59, and the critical value was 22.3, thus we failed to reject the null at significance level 0.05. As a result, we could not find appropriate instrumental variables for spirits in the current dataset. If more measures are availble, such as other alcohol regulations and other alcohol consumption information, we might be able to find more suitable instrument variables.

# Discussion 


# Acknowledgement {-}


# Reference {-}


# Session info {-}


```{r}
sessionInfo()
```
